<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>Attacking and Defending Azure Storage Blobs</title> 
    <meta name="description" content="As more organizations adopt cloud technologies, more attackers recognize the value of data stored in these environments. However, many organizations fail to realize just how important the security of their data is...until they find it on the dark web! 
    This blog will present a scenario from start to finish of how not* to abuse your Azure storage blobs. ">  
    <meta name="author" content="kogatana-x">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv='content-language' content='en-us'> 
    <meta name="keywords" content="kogatana-x, offensive security, defensive security, sysadmin, programming">
    
    <meta property="og:title" content="Attacking and Defending Azure Storage Blobs">
    <meta name="category" content="offensive">

    <link rel="canonical" href="https://kogatana-x.github.io/posts/Attacking-and-Defending-Azure-Storage-Blobs.html" />  <!--TODO-->
    <link rel="icon" href="https://kogatana-x.github.io/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/styles/default.min.css">
    <link rel="stylesheet" href="https://kogatana-x.github.io/kogatana-x.css">

    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/languages/javascript.min.js"></script>
</head>
<body>

    <div class="navbar">
        <a href="https://kogatana-x.github.io/">
            <img src="https://kogatana-x.github.io/images/22989723.png" alt="Profile"> 
        </a>
        <h2>kogatana-x</h2>
        <p>Offensive//Defensive Security</p>
        <div class="social">
            <a href="https://github.com/kogatana-x" target="_blank" rel="noreferrer noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ee4c4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
                    <title>Github</title>
                    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                </svg>
            </a>
            <a href="https://www.linkedin.com/in/anna-andler" target="_blank" rel="noreferrer noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ee4c4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
                    <title>LinkedIn</title>
                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
                </svg>
            </a>
        </div>
    </div>

    <div class="content">
        <div class="banner">
            <pre>

██╗  ██╗ ██████╗  ██████╗  █████╗ ████████╗ █████╗ ███╗   ██╗ █████╗      ██╗  ██╗
██║ ██╔╝██╔═══██╗██╔════╝ ██╔══██╗╚══██╔══╝██╔══██╗████╗  ██║██╔══██╗     ╚██╗██╔╝
█████╔╝ ██║   ██║██║  ███╗███████║   ██║   ███████║██╔██╗ ██║███████║█████╗╚███╔╝ 
██╔═██╗ ██║   ██║██║   ██║██╔══██║   ██║   ██╔══██║██║╚██╗██║██╔══██║╚════╝██╔██╗ 
██║  ██╗╚██████╔╝╚██████╔╝██║  ██║   ██║   ██║  ██║██║ ╚████║██║  ██║     ██╔╝ ██╗
╚═╝  ╚═╝ ╚═════╝  ╚═════╝ ╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝     ╚═╝  ╚═╝                                                                                 

──────────────────────────────────────────────────────────────────────────────────
            </pre>
        </div>       
        <div class="blog-post">   
            <h1 id="Attacking-and-Defending-Azure-Storage-Blobs">Attacking and Defending Azure Storage Blobs</h1> 
            <time datetime="2025-01-23T20:19:55">January 23th, 2025</time> 
            <pre>
──────────────────────────────────────────────────────────────────────────────────</pre>
            <p><i>As more organizations adopt cloud technologies, more attackers recognize the value of data stored in these environments. However, many organizations fail to realize just how important the security of their data is...until they find it on the dark web! 
                This blog will present a scenario from start to finish of how not* to abuse your Azure storage blobs. </i></p>
            <h2 id="Introduction">Introduction</h2>
            <p>Before we get into the meat and potatoes, we should probably establish what cloud storage actually is. To put it simply, much like the rest of the cloud, cloud storage is just someone else's computers that has the data you store at any given time. So when you purchase an Azure Storage Blob from Microsoft, they'd store that data on one, or a few of their servers depending on your region and availability tier you select. </p>
            <p>Azure has two (well three if we are getting technical) types of storage you can purchase. Blob, and General Purchase (which contains Blob and a few other types: File, Queue, and Table). We are only going to care about Blob Storage for this blog, but they all function similarly enough on the front-end.</p>
            <p>Blob Storage is, at its core, designed to store massive amounts of unstructured data. In traditional file systems, we are used to seeing documents, images, and executables - blob storage can include those, but is more intended for data that doesnt have a defined type such as archives, log files, banking information, health information, etc.</p>
            <p>Below is an image of what blob storage looks like in the Azure Portal.</p>
                <img src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/1-Azure-Blob-Containers.png" alt="Azure Blob Storage">
            
            <h3 id="Anatomy-of-Blob-Storage">Anatomy of Blob Storage</h3>
            <p>To understand the absolute minimum needed for a theoretical attacker to target a storage blob, they'd only have to need to collect a storage account, a container, and blob name in order to access data.</p>
            <p><b>Storage Account: </b>basically a username. this is also the thing that has authorization to access blobs</p>
            <p><b>Container: </b>think of this as a folder that has the blobs</p>
            <p><b>Blob: </b>the actual data stored in the container</p>
            <p>    There are three types of blob data: Block, Append, and Page. Block is the one we care about and will be targetting and this simply stores text and binary data, much like we are accustomed to.</p>
                <img src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/2-Azure-Blob-Storage-Structure.png" alt="Azure Blob Storage Hierarchy">
                        <pre>
──────────────────────────────────────────────────────────────────────────────────</pre>
            
            <h2 id="Attacking-Storage-Blobs">Attacking Storage Blobs</h2>
            <p>I believe the best defenders are good attackers, and good defenders make for better red teamers and pentesters, so we will be covering both sides in this post, starting with attack.</p>
            <p>And as an attacker, there always has to be some sort of thing that motivates them to put in the effort. So, why would an attacker care about Azure Storage Blobs?</p>
            <p>Attackers can abuse public-facing blobs as an easy target for data exfiltration, or gathering credentials or information that can be used to gain entry into a network, or piviot from within. More commonly, attackers can gain access to particularly, juicy, sensitive data as more of a late-stage objective, once they have already gained access to the internal network and have recovered credentials. This is when financially-motivated attackers are likely to ransom data, and even sell it on the dark web to the highest bidder. Some other threat actors even take over blob storage as a hosting domain for their evil infrastructure and malwares. Vigilantes with the right permissions and the wrong incentives can even delete all of the data stored in the blob. </p>
            <p>Moreover, storage blobs are valuable targets that threat actors frequently target and exploit their way into.</p>

            <h3 id="Finding-a-Target">Finding a Target</h3>
            <p>*Obvious Disclaimer
                Ensure you have proper authorization before doing any non-passive reconnaissance and other testing. Don't do illegal things!
            </p>
            <h4 id="Reconnissance">Step #1 - Reconnissance</h4>
            <p>An attacker performing reconnissance to identify vulnerable target blobs needs to find three things: a storage account, a container, and a blob name. </p>
            <p>We went over what those are in <a href="#Anatomy-of-Blob-Storage">Anatomy of Blob Storage</a>. Three things sound easy enough!</p>

            <h3 id="Accessing-the-Target">Accessing the Target</h3>
            <p>In file systems we are accustomed to, like the File Explorer in Windows, we open the application, click on the folder that stores our document, then open the file we want to see. If we have something like a NAS, we first, make sure to point the folder we open to the computer that is hosting that data. Accessing Azure Storage Blobs is very similar to that. </p>
            <p>All we need is a URL that is unique to the blob we want to access, and plop it in a browser such as Chrome, Firefox, Safari, etc.</p>
            <p>This endpoint is comprised of the three components we need to identify.</p>
            <pre><code>http://{storage-account}.[blob|file|table|queue].core.windows.net/{container}/{file}</code></pre>
            <p>So if our storage account name is "bonzibuddy", the container we want to access is "peedy-pictures", and the blob we want to target is "flexing.png", our URL would look like this:</p>
            <pre><code>http://bonzibuddy.blob.core.windows.net/peedy-pictures/flexing.png</code></pre>
            <p>We can also get a bit fancier and use the Azure Storage REST API, Azure PowerShell, Azure CLI, and any other client library that supports it.</p>
            <p>The operations we use to access the blob using the REST API is mapped to the operations we are used to graphically -</p>
            <pre><code> Get Container Properties
 List Containers (in a storage account) 
 List Blobs (in a container)
 Get Blob  (retrieve data)</code></pre>

            <h3 id="Finding-a-Target">Finding a Target</h3>
            <p>Much like finding any other public-facing web page on the internet, we can use some more traditional tactics such as Google Dorking and DNS Enumeration.</p>
            <p>Google Dorking is a syntax that anyone can use to filter a search by specifying criteria for the results we want to see.</p>
            <p>For example, if we wanted to find all the public-facing Azure Storage Blobs that has xlsx or csv files with the word "password" in them, we could use the following Google Dork:</p>
            <pre><code>site:*.blob.core.windows.net ext:xlsx | ext:csv password</code></pre>
            <p>With DNS enumeration, we can use a script such as DNScan to brute-force query Microsoft's public DNS records for common blobs to target.</p>
            <pre><code>python dnscan.py -d blob.core.windows.net -w subdomains.txt</code></pre>
            <p>There are also custom tools out there, such as MicroBurst that package a lot of this reconnissance work for automagic results.</p>
            <pre><code>Invoke-EnumerateAzureBlobs –Base</code></pre>

            <video controls width="65%">
                <source src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/3-Google-Dorking-EX.mp4" type="video/mp4">
                This would be a video, if your browser supported it.
            </video>

            <h3 id="Blob-Storage-Permissions">Blob Storage Permissions</h3>
            <p>The results we saw in our open reconnaissance were only available to us because they had either "Blob" or "Container" level permissions set.</p>
            <p><b>Blob:</b> public read access for blobs only.
                  Blobs => anonymous read
                  Container data => access via authorized request.
            </p>
            <p><b>Container:</b> public read access for containers and blobs.
                  Container and blob data => anonymous read
                  (excluding container permission settings/metadata)
            </p>
            <p><b>Private:</b> no public read access.
                  Blobs and containers => access via authorized request.
                  This means we'd need a shared key from a storage account, or a Shared Access Signature (SAS) URI generated to view the data.
            </p>
            <p>TLDR; only containers with the Public read access will allow unauthorized requests. This would mean an attacker needs to know the full URL of the blob to access blob data with Blob level permissions configured.</p>              

            <h3 id="Enumeration">Not-so-Stealthy Enumeration</h3>
            <p>Assuming we had identified a storage account named "bonzibuddy" in the previous step, we can move right along in finding the rest of the information.</p>
            <h4>Step #2 - Enumeration</h4>
            <p>Like any other webpage, there are attackers out there that like to throw scans at the wall that is the internet and hope something sticks. These attackers might have a bit of a tough time due to some anti-scanning measures Microsoft built in to Azure Storage.</p>
            <p>Although, making a wordlist is easy - there really aren't any restrictions for what the URL can or cannot have beyond properly escaping some special characters and not exceeding a reasonable amount of characters.</p>
            <p>An attacker can use a page enumeration tool such as gobuster to identify container names and blob names using a wordlist.</p>
            <pre><code>gobuster dir -u http://bonzibuddy.blob.core.windows.net -w wordlist.txt
gobuster dir -u bonzibuddy.blob.core.windows.net -w /usr/share/wordlists/dirb/big.txt -x xlsx,png</code></pre>
                <p>When an empty container is hit, the page would return a 400 error, and when a container with blob permissions is hit, it would return a 404 error, making identifying good targets harder.</p>
            <p>As we know, enumerating this method is not stealthy, the web server will be flooded with requests.</p>

            <h3 id="Enumerating-AZCLI">Enumerating the Target</h3>
            <p>Let's imagine we have access to a tool like Azure CLI and want to blend in with the environment a bit more.</p>
            <p>Using the Azure CLI, we can list storage accounts:</p>
            <pre><code>az storage account list</code></pre>
            <p>The key associated with a storage account: </p>
            <pre><code>az storage account keys list --account-name bonzibuddy</code></pre>
            <p>And then we can list the containers in the storage account:</p>
            <pre><code>az storage container list --account-name bonzibuddy --account-key {key}</code></pre>
            <p>And finally, list the blobs in the container:</p>
            <pre><code>az storage blob list --account-name bonzibuddy --account-key {key} --container-name peedy-pictures</code></pre>

            <video controls width="65%">
                <source src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/4-Enumerating-Blob-Azure-CLI.mp4" type="video/mp4">
                This would be a video, if your browser supported it.
            </video>
            <h3 id="Exfiltration">Complete the Mission</h3>
            <p>Now that we identified the container name and blob to target, we can now complete our mission!</p>
            <p>Using the Azure CLI, we can download the blob to our local machine:</p>
            <pre><code>az storage blob download --account-name bonzibuddy --account-key {key} --container-name peedy-pictures --name flexing.png --file flexing.png</code></pre>
            <p>Using a tool like Microburst, we could do the same thing: </p>
            <pre><code>Invoke-WebRequest –Uri https://storageaccount.blob.core.windows.net/peedy-pictures/flexing.png –OutFile flexing.png</code></pre>
            <p>If we had downloaded a bunch of bulk data, we can use a tool like DumpsterDiver to find some more juicy bits like keys and sensitive information.</p>
            <pre><code>DumpsterDiver.py -p [PATH_TO_FOLDER] --min-key 66 --max-key 66 --entropy 5.1
DumpsterDiver.py -p [PATH_TO_FOLDER] --min-pass 10 --max-pass 15 --pass-complex 8</code></pre>
            <p>There is also always good ole grep ;)</p>

            <p>And that's it! That is all an attacker needs to do to "attack" an Azure Storage Blob. </p>
            <video controls width="65%">
                <source src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/5-Hackinggg.mp4" type="video/mp4">
                This would be a video, if your browser supported it.
            </video>

            <pre>
──────────────────────────────────────────────────────────────────────────────────</pre>
            <h2 id="Defending-Azure-Storage-Blobs">Defending Azure Storage Blobs</h2>
            <p>Now that we know how an attacker can target Azure Storage Blobs, we can now discuss how to defend against these attacks.</p>
           
            <p>When investigating a potential compromise, we need to gather information that will help us understand the extent of the compromise and identify the source of the attack. This information can be used to determine the appropriate response to the attack and prevent future attacks.</p>
            <p>We need to find the affected storage account (to cycle keys and SAS URIs), the blob data accessed/modified (for the extent of the compromise), and the container with the permissions issue (to fix the ACL). Then for attribution, we need to find the source IP of the activity and the time the activity occured to investigate correlated events.</p>
            
            <p>In Azure we can leverage the Activity logs contained in the Monitor portal that are configured by default. The extent these go to document events around storage blobs is...limited. </p>
                <p>For instance, in the attacks we just completed in our example, the only events that are logged by default is the "List Storage Account Keys" event.</p>
                <img width="70%" src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/11-List-Keys.png" alt="Defending Azure Storage Blobs">
                <p>If we pay close attention, we can identify the source, time, and effected storage account, however making a concrete assertion that the activity was bad is difficult with this information alone.</p>
                <p>As we poke around the portal a bit more, we can stumble into the 'Failure Insights' page, which suprisingly gives us some solid logs to piviot off of. We can gather the full request URI, the authentication type (anonymous or if an account was used), operation performed against the blobs, as well as time and source.</p>
                <img src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/6-Failure-Insights-EX.png" alt="Defending Azure Storage Blobs">
                <p>Like the name implies, only failed events are logged, so this may require a stroke of luck. Likewise, logs roll quickly without some type of intervention, so it may be difficult to properly investigate later down the line.</p>
            

            <h3 id="Configuring Blob Logs">Configuring Blob Logs</h3>
            <p>To save ourselves some grief, we can configure Blob Logs to capture more detailed information about the activity on our storage blobs. This can be done in the Azure Portal under the 'Storage Settings' tab.</p>
            <p>Once we have the logs enabled, we can view them in the 'Blob Log' tab. This will give us a more detailed view of the activity on our storage blobs, including the source IP, the time of the activity, and the operation performed.</p>

            <video controls width="65%">
                <source src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/7-Configuring-Blob-Logs.mp4" type="video/mp4">
                This would be a video, if your browser supported it.
            </video>
            <p>Once we have the logs enabled, we actually can view them in the blob itself from the "$log" container. This will give us a more detailed view of the activity on our storage blobs, including the source IP, the time of the activity, the operation performed, and even the User Agent used, regardless of result (success/fail).</p>
            <video controls width="65%">
                <source src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/10-Log-Location.mp4" type="video/mp4">
                This would be a video, if your browser supported it.
            </video>

            <p>Since this was a lot, to summarize, we need to configure, at a minimum these settings:</p>
            <img width="30%" src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/8-Storage-Settings.png" alt="Defending Azure Storage Blobs">
            <p>In order to get these types of logs:</p>
            <img width="50%" src="https://kogatana-x.github.io/images/Attacking-and-Defending-Azure-Storage-Blobs/9-Blob-Log.png" alt="Defending Azure Storage Blobs">
            

            <h3 id="Microsoft-Defender-for-Storage">Microsoft Defender for Storage/Cloud</h3>
            <p>Microsoft Defender for Storage and Cloud make it easier to detect and respond to threats in Azure Storage Blobs. While this costs a pretty penny and may be out of reach for small-size entities, the anomaly and rule-based detections are still worth mentioning for those that employ them.</p>
            <p>Some detections include:
                <ul>
                    <li>Publicly accessible storage containers discovered</li>
                    <li>Unusual Storage Blob Access</li>
                    <li>Malware Detected in Blob</li>
                    <li>Unusual Deletions</li>
                    <li>Unusual amount of data extracted from a storage account</li>
                </ul>
            </p>
            
                        <pre>
──────────────────────────────────────────────────────────────────────────────────</pre>
                <h2 id="Conclusion">Conclusion</h2>
                <p>Azure Storage Blobs are a valuable target for attackers, and it is important to understand how they can be targeted and exploited. By understanding how attackers can target them, organizations can better defend against these attacks. By following the defense concepts outlined in this blog, organizations can better protect their Azure Storage Blobs from attackers. </p>
                <p>Make sure to turn on those logs and alerting, and avoid anonymous permissions where possible. Once it's too late to configure this, 'List Storage Account Key' events and Failure Insights may be of use in an investigation.</p>
            
        </div>
    </div>
    <div class="footer">
        <p>© 2021 kogatana-x</p>
    </div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
  document.querySelectorAll('pre code').forEach((block) => {
    hljs.highlightElement(block);
  });
});
</script>
</html>
