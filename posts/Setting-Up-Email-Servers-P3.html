<!DOCTYPE html>
<html>
<head>
    <title>Setting Up Email Servers - Part 3</title> 
    <meta name="description" content="Third part of the Setting Up Email Servers series, where we will go over setting up an email server on Linux">   
    <meta name="author" content="kogatana-x">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="language" content="en">
    <meta name="keywords" content="kogatana-x, offensive security, defensive security, sysadmin, programming">
    
    <meta property="og:title" content="Setting Up Email Servers - Part 3">
    <meta name="category" content="sysadmin">


    <link rel="icon" href="https://kogatana-x.github.io/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/styles/default.min.css">
    <link rel="stylesheet" href="https://kogatana-x.github.io/kogatana-x.css">

    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/languages/javascript.min.js"></script>
</head>
<body>

    <div class="navbar">
        <a href="https://kogatana-x.github.io/">
            <img src="../images/22989723.png" alt="Profile"> 
        </a>
        <h2>kogatana-x</h2>
        <p>Offensive//Defensive Security</p>
        <div class="social">
            <a href="https://github.com/kogatana-x" target="_blank" rel="noreferrer noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ee4c4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
                    <title>Github</title>
                    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                </svg>
            </a>
            <a href="https://www.linkedin.com/in/anna-andler" target="_blank" rel="noreferrer noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ee4c4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
                    <title>LinkedIn</title>
                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
                </svg>
            </a>
        </div>
    </div>

    <div class="content">
        <div class="banner">
            <pre>

██╗  ██╗ ██████╗  ██████╗  █████╗ ████████╗ █████╗ ███╗   ██╗ █████╗      ██╗  ██╗
██║ ██╔╝██╔═══██╗██╔════╝ ██╔══██╗╚══██╔══╝██╔══██╗████╗  ██║██╔══██╗     ╚██╗██╔╝
█████╔╝ ██║   ██║██║  ███╗███████║   ██║   ███████║██╔██╗ ██║███████║█████╗╚███╔╝ 
██╔═██╗ ██║   ██║██║   ██║██╔══██║   ██║   ██╔══██║██║╚██╗██║██╔══██║╚════╝██╔██╗ 
██║  ██╗╚██████╔╝╚██████╔╝██║  ██║   ██║   ██║  ██║██║ ╚████║██║  ██║     ██╔╝ ██╗
╚═╝  ╚═╝ ╚═════╝  ╚═════╝ ╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝     ╚═╝  ╚═╝                                                                                 

──────────────────────────────────────────────────────────────────────────────────
            </pre>
        </div>       
        <div class="blog-post">   
            <h1>Setting Up Email Servers - Part 3</h1> 
            <time datetime="2024-03-6T01:01:44">March 6th, 2024</time> 
            <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
            <h2>Introduction</h2>
            <p>
                Welcome to the third part of the Setting Up Email Servers series. In this part, we will go over setting up an email server on Linux.
                We will be using Postfix as our Mail Transfer Agent (MTA), Dovecot as our Mail Delivery Agent (MDA), and Roundcube as our webmail client, with Apache as the web server and MariaDB as the backend database.
                If you have been following along, you should have a basic understanding of how email servers work and be comfortable with making command-line configuration changes.
                For now, we will stick to local authentication, but we will be exploring various configuration options and security considerations in future iterations of this series.
                <br>__<br>
                <ol>
                <li><strong>Postfix</strong> is a free and open-source mail transfer agent (MTA) that routes and delivers electronic mail. It is Wietse Venema's mail server that started life at IBM research as an alternative to the widely-used Sendmail program. Now at Google, Wietse continues to support Postfix.</li>
                <li><strong>Dovecot</strong> is an open-source IMAP and POP3 server for Unix-like operating systems, written primarily with security in mind. Dovecot is an excellent choice for both small and large installations. It's fast, simple to set up, requires no special administration, and it uses very little memory.</li>
                <li><strong>Roundcube</strong> is a web-based IMAP email client. Roundcube's most prominent feature is the pervasive use of Ajax technology. It was one of the first webmail services to use the technology, and it was one of the first to offer a user interface that was more like a desktop application than a traditional web application.</li>
                <li><strong>Apache</strong> is a free and open-source cross-platform web server software. Apache is developed and maintained by an open community of developers under the auspices of the Apache Software Foundation.</li>
                <li><strong>MariaDB</strong> is a community-developed, commercially supported fork of the MySQL relational database management system (RDBMS), intended to remain free and open-source software under the GNU General Public License. Development is led by some of the original developers of MySQL, who forked it due to concerns over its acquisition by Oracle Corporation.</li>
                </ol>
            </p>
            <p>Below is a diagram illustration of how all of these different email components come together</p>
            <img style="width:50%;" src="https://kogatana-x.github.io/images/Setting-Up-Email/holygrailflow.png" alt="Email Server Diagram">
             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
            <h2>Prerequisites</h2>
            <p>
                Before we begin, you will need to have a server running a Linux distribution. This guide follows both RHEL-based and Debian-based OSes, any other type, youll have to figure out on your own. You will also need to have a domain name and a server with a static IP address. For the purposes of this tutorial, the domain can be whatever you wish. You will also need to have a basic understanding of how to use the command line and be comfortable with making configuration changes.
                <br>Note, there are a few things on a freshly installed machine that may pose a bit of an issue later down the line:
                SELinux should be disabled or, figure out those exceptions manually (vi /etc/selinux/config) prior to starting.
                Also, sendmail (another MTA) is likely to be installed by default on your OS (and will take precedence over Postfix), so make sure it is disabled (systemctl disable sendmail).
            </p>

            <h3>Downloads</h3>
            <h4>RHEL-type OS</h4>
            <pre><code>
yum install postfix dovecot
yum install roundcubemail httpd php php-common php-json php-xml php-mbstring php-imap php-pear-DB php-mysql mysql mysql-server (mod_nss or mod_ssl for HTTPS)
dnf -y install mariadb-server php-mysqlnd
        </code></pre>
            Debian type OS
            <pre><code>
apt-get install postfix dovecot-pop3d dovecot-imapd php5 mysql-server  php5-mysql

#This is intended for Debian 8/ Ubuntu 15, if you are using a newer OS go w that and use php7 
wget github.com/roundcube/roundcubemail/releases/download/1.3.14/roundcubemail-1.3.14-complete.tar.gz
tar -zxvf roundcubemail-1.3.14-complete.tar.gz

#may have to apt-get install -f 
mv roundcubemail-1.3.13-complete /var/www/html/roundcube
        </code></pre>
             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
        <h2>Postfix MTA</h2>
        <p>Postfix is a type of MTA that supports the transport of messages across servers. <a link="https://web.archive.org/web/20171127055338/http://www.linuxmail.info/postfix-howtos/"> Reference </a></p>
        <h3>Supporting Command Reference</h3>
        <pre><code>
mailq/postqueue #views the contents of the Postfix queue (size | time of arrival | sender addr | rcpt addr )
newaliases/postalias #rebuilds local alias/email mapping files (ones stored on the pc)
postconf #shows Postfix’s configuration values(can also be used to modify it & check for errors)
postfix #the service name to start/stop/restart Postfix
postmap #rebuilds an indexed database file used for table lookups/queries any lookup table. Used for debugging purposes.
postqueue #also used to flush the queue (immediately deliver all messages)
postsuper #delete or requeue already sent items, and can perform structural checks on queue directions
</code></pre>

<h3>Security-Related Information</h3>
<ul>
    <li>in most cases, mail delivery does not require a shell</li>
    <li>most processes are executed by a master daemon
        <ul>
            <li>and do not run as a user child process</li>
        </ul>
    </li>
    <li>does not used fixed-size buffers </li>
    <li>can chroot postfix**</li>
</ul>
<h3>Defaults</h3>
<pre><code>
#Directories
/etc/postfix       #Configuration files and lookup tables
/usr/libexec/postfix     #Postfix daemons
/var/spool/postfix  #Queue files
/usr/sbin   #Postfix commands

#Users
postfix = user
postdrop = group
</code></pre>

<h2> Local Authentication </h2>
<h3>Configure</h3>
<pre><code>
vi /etc/postfix/main.cf
myhostname = <hostname>.<domain>
mydomain = <domain>
myorigin = $mydomain
inet_interfaces = all
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
mynetworks = <network>/<prefix>,127.0.0.0/8 
home_mailbox = Maildir/  or Mail
#relayhost = <ip> if you have to go through an ISP >> don’t actually worry eh
#Mailbox Creation* (only in older versions)
mkdir /home/<username>/Mail
chown <user>:<user> /home/<user>/Mail
chmod -R 700 /home/<user>/Mail
postalias /etc/aliases
</code></pre>
<h3>Start/Restart Postfix</h3>
<pre><code>
systemctl start postfix #you cant reload, b/c inet_interfaces was likely changed from default of loopback
systemctl restart postfix
</code></pre>
<h3>Test Connectivity</h3>
<pre><code>
telnet localhost 25
ehlo localhost
mail from: <username>@<domain>
rcpt to: <username>@<domain>
data
<whatever your message is>
.
quit
</code></pre>
<h3>See if the mail was actually sent</h3>
<pre><code>
mail
</code></pre>

             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
<h2>Dovecot MDA - IMAP/POP3</h2>
<h3>Local Authentication</h3>
<h3>Configure</h3>
<pre><code>
vi /etc/dovecot/dovecot.conf
protocols = imap pop3 (lmtp for local mail transfer)

vi /etc/dovecot/conf.d/10-mail.conf
mail_location = maildir:~/Mail

vi /etc/dovecot/conf.d/10-auth.conf
disable_plaintext_auth = no #ref ssl
auth_mechanisms = plain login

vi /etc/dovecot/conf.d/10-master.conf
unix_listener auth-userdb {
    #mode
    user = postfix
    group = postfix
}
</code></pre>

<h3>Start/Restart Dovecot</h3>
<pre><code>
systemctl start dovecot 
systemctl status dovecot
</code></pre>

<h3>Test Connection</h3>
<pre><code>
#TEST POP3
telnet localhost 110
user <username>
pass <pass>
list
retr <#>
quit

#TEST IMAP
telnet localhost 143
a1 LOGIN <username> <password>
a2 LOGOUT
</code></pre>

<h3>OPTIONAL >> Aliases</h3>
<pre><code>
vi /etc/aliases
test1:  test  #mail sent to test1 will go to test
test66: test

vi /etc/postfix/main.cf
virtual_alias_domains = domain1.example.com, domain2.example.com

</code></pre>
             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
<h2>PHP</h2>
<h3>Test if install works</h3>
<pre><code>
vi /var/www/html/index.php
<?php
   phpinfo();
?>
</code></pre>
navigate to localhost and see if this works:
<pre><code>
    http://localhost/index.php
</code></pre>
then remove the test file
<pre><code>
rm -f /var/www/html/index.php
</code></pre>
<h3>Configure PHP Settings</h3>
RHEL type OS:
<pre><code>
vi /etc/php.ini
date.timezone = America/Chicago #or UTC
extension=mysql.so
systemctl start httpd 
systemctl status httpd #make sure its running
systemctl enable httpd
chown -R apache:apache /var/www/html
</code></pre>
Debian type OS
<pre><code>
vi /etc/php5/apache2/php.ini
date.timezone = America/Chicago #or UTC
extension=mysql.so
systemctl start apache2 
systemctl status apache2 #make sure its running
chown -R www-data:www-data /var/www/html
</code></pre>
             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>

<h2>MySQL</h2>
<pre><code>
systemctl start mysql/d #or mariadb
</code></pre>
Debian type OS
<pre><code>
#create database
mysql --defaults-file=/etc/mysql/debian.cnf
create database roundcubemail; 
create user roundcube; 
grant all privileges on roundcubemail.* to roundcube@localhost identified by 'your password'; 
flush privileges; 
use roundcubemail; 
quit #or exit;

#if the above doesnt work, use this method to set the password:
FOR 'roundcubemail'@'localhost' = PASSWORD('newpassword');
</code></pre>
RHEL type OS
<pre><code>
mysql -u root -p
    create database roundcubemail; 
    create user roundcube; 
    grant all privileges on roundcubemail.* to roundcube@localhost identified by 'your password'; 
    flush privileges; 
    use roundcubemail; 
    quit #or exit;

    #inititalize database
mysql -u root -p roundcubemail < /usr/share/roundcubemail/SQL/mysql.initial.sql
   
</code></pre>
             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
<h2>Roundcube (WebApp)</h2>
<h3>Install (With A GUI)</h3>
Navigate to
<pre><code>
http://localhost/roundcubemail/installer
</code></pre>
<h4>Step 1 - Check preqs</h4>
<h4>Step 2 - Configure</h4>
<p>make sure you add the password to the database conf. that’s all you have to do
but you should probably specify a hostname and domain instead of localhost</p>
download the conf file in step 2 and move it to /var/www/html/roundcube/config/config.inc.php
<h4>Step 3</h4>
Test your configuration if you are unsure, but you don’t actually have to do this.

<h4>Step 4 - Edit Configuration Files</h4>
<pre><code>
vi /etc/roundcubemail/db.inc.php
$rcmail_config['db_dsnw'] = 'mysql://
roundcube:password@localhost/roundcubemail';
</code></pre>
OR
<pre><code>
vi /var/www/html/roundcube/config.inc.php
$config[‘db_dsnw’] = 'mysql://roundcube:password@localhost/roundcubemail';
</code></pre>

<h4>Step 5 - Acquire Mail</h4>
<pre><code>http://localhost/roundcubemail</code></pre>
*If you cant login >>
<pre><code>
vi /var/www/html/roundcube/config/config.inc.php
[type] /username_domain
and comment that line out
</code></pre>
             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
<h2>Troubleshooting</h2>
<h3>Postfix</h3>
<pre><code>
postconf -n # to see current settings
postconf -d # to see default values

#what errors?
systemctl status postfix 
tail /var/log/maillog

#resolve config errors
postfix check
postfconf 1> /dev/null

#check directory permissions
chattr -R -i /var/log/
chattr -R -i /etc/postfix/
ls -l /var/log && ls -l /etc/postfix

#check the firewall logs for dropped SMTP traffic
vi /var/log/messages | grep ‘:drop_log:’

#monitor smtp traffic
tcpdump -w /file/name -s 0 host example.com and port 25 
tcpdump -i  -vv -x -X -s 1500 -i <eth2> ‘port 25’  #Verbose Output for SMTP

#get very verbose log output
vi /etc/postfix/master.cf:
    smtp      inet  n       -       n       -       -       smtpd -v
postfix reload

#if connected to ldap - 
    postmap -q user@domain.com ldap:/path/to/ldap/conf

#find networks
cat /etc/postfix/main.cf | grep “mynetworks”
cat /etc/postfix/main.cf | grep “mydomain”

</code></pre>
<h3>Dovecot</h3>
<pre><code>
dovecot -n #to see current settings
dovecot -n -c /etc/dovecot/dovecot.conf #to see current settings
dovecot -n -c /etc/dovecot/dovecot.conf | grep -i ‘ssl’ #to see current settings
dovecot -n -c /etc/dovecot/dovecot.conf | grep -i ‘auth’ #to see current settings

# what errors?
cat /var/log/maillog >> maillog

#check the firewall logs for dropped IMAP/POP traffic
vi /var/log/messages | grep ‘:drop_log:’ #if you have logging set up for iptables

</code></pre>
<h3>Roundcube/Apache</h3>
<pre><code>
#check the logs
    tail /var/log/httpd/access_log
    tail /var/log/httpd/error_log 

#monitor traffic
    tcpdump -i eth2 ‘port 80’  

#normal httpd.conf
https://github.com/assistanz247/APACHE/blob/master/httpd.conf

</code></pre>
<h3>MySQL</h3>
<pre><code>
#check the logs
    tail /var/log/mysqld.log
    tail /var/log/mysql/error.log

#monitor traffic
    tcpdump -i eth2 ‘port 3306’

#if it doesn’t start: my.cnf
#check user permissions
#check password configs for the webserver
#**make sure your fw rules allow for external SQL/ loopback 

#check the firewall logs for dropped External SQL connections (if applicable)
    vi /var/log/messages | grep ‘:drop_log:’
                
</code></pre>
             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
<h2>Hardening</h2>
<h3>Firewall</h3>
<pre><code>
#NOTE: *SASL is for 587, smart host relays (starttls encryption)

#Core Services
iptables -A INPUT -p tcp -m multiport --dports 25,80,110,143 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -m multiport --sports 25,80,110,143 -m state --state ESTABLISHED -j ACCEPT

#SQL Database connection
iptables -A INPUT -s 172.20.240.20 -p tcp  --sport 3306 -j ACCEPT
iptables -A OUTPUT -d 172.20.240.20 -p tcp --dport 3306 -j ACCEPT

#AD connection 
iptables -A INPUT -s 172.20.242.200 -p tcp --sport 389 -j ACCEPT
iptables -A OUTPUT -d 172.20.242.200 -p tcp --dport 389 -j ACCEPT
</code></pre>
<h3>Logging</h3>
<h4>Roundcube/Apache</h4>
<pre><code>
#In the roundcube config file -- config.inc.php
$config['debug_level'] = 1; #System Error Reporting
$config['sql_debug'] = true; # Log SQL queries
$config['imap_debug'] = true; #Log IMAP4 conversation
$config[pop_debug’]=true; #Log POP3 converstation
$config['ldap_debug'] = true; #Log LDAP conversation
$config['smtp_debug'] = true; #Log SMTP conversation
</code> </pre>
<h4>Postfix</h4>
<pre><code>
postconf -e smtp_tls_loglevel=1
notify_classes = resource, software, protocol
</code></pre>
<h4>Dovecot</h4>
<pre><code>
#located: /var/log/maillog or /var/log/mail.info or something similar
#the postfix mail queue is located in the directory tree /var/spool/postfix and below
</code></pre>
<h4>Apache</h4>
<pre><code>
#located in /var/log/httpd or /apache2
</code></pre>
   
<h3>Backup</h3>
<h4>Postfix</h4>
<pre><code>
tar czf /root/postfix-$(date “+%F”).tar.gz /etc/postfix
postconf > /root/postconf-$)date “+%F)
</code></pre>
<h4>Dovecot</h4>
<pre><code>
tar czf /root/dovecot-$(date “+%F”).tar.gz /etc/dovecot
</code></pre>
<h2>Postfix Hardening – Hella ExtraTM</h2>
<h3>Chroot Jail</h3>
<pre><code>
mkdir -p /var/spool/postfix/dev
syslogd -a /var/spool/postfix/dev/log
vi main.cf
</code></pre>
<h3>Domain Restrictions</h3>
<pre><code>
*can combine w/ a comma
smtpd_client_restrictions =reject_non_fqdn_sender, reject_non_fqdn_recipient
smtpd_client_restrictions = warn_if_reject reject_unknown_client
smtpd_client_restrictions = check_client_access hash:/etc/postfix/client_access
#vi /etc/postfix/client_access file:
    10                          REJECT RFC 1918 address not allowed here
    192.168                     REJECT RFC 1918 address not allowed here
    # Known spammers
    12.34.56.78			        REJECT 
	spammer.example.com 		REJECT
</code></pre>
<h3>Message Content Checks</h3>
<pre><code>
mime_header_checks = /^Content-(Disposition|Type).*name\s*=\s*"?(.*\.( ade|adp|bas|bat|
    chm|cmd|com|cpl|crt|dll|exe|hlp|hta|inf|ins|isp|js|jse|lnk|mdb|mde|mdt|
    mdw|ms[cipt]|nws|ops|pcd|pif|prf|reg|sc[frt]|sh[bsm]|swf|vb[esx]?|vxd|
    ws[cfh]))(\?=)?"?\s*(;|$)/x
REJECT Attachment not allowed. Filename "$2" may not end with ".$3".
</code></pre>
<h3>Initial Scan of Postfix</h3>
<pre><code>
#check config & resolve any errors
postfconf 1> /dev/null
#find version
dpkg -l postfix OR postconf mail_version | awk -F” = “ ‘{print $2}’
#check networks
cat /etc/postfix/conf.php | grep “mynetworks”
</code></pre>
             <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>

<h2>Conclusion</h2>
<p>With that, your email server should be up and running. If you are an engineer, I cannot and will never reccomend using plaintext authentication. What we did in the lab is not secure, and will not scale very well with many many users. In the next post, we will go over some more secure options, as well as using directories via LDAP and Kerberos authentication. 
<br>Happy testing!
</p>
        </div>
    </div>
    <div class="footer">
        <p>© 2021 kogatana-x</p>
    </div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
  document.querySelectorAll('pre code').forEach((block) => {
    hljs.highlightElement(block);
  });
});
</script>
</html>
