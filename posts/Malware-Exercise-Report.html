<!DOCTYPE html>
<html>
<head>
    <title>Malware Exercise Report</title>
    <meta name="description" content="Sample report of a reverse engineering exercise I made for a cybersecurity competition a few years back."> 
    <meta name="author" content="kogatana-x">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv='content-language' content='en-us'> 
    <meta name="keywords" content="kogatana-x, offensive security, defensive security, sysadmin, programming">
    
    <meta property="og:title" content="Malware Exercise Report">
    <meta name="category" content="defensive">

    <link rel="canonical" href="https://kogatana-x.github.io/posts/Malware-Exercise-Report.html" />

    <link rel="icon" href="https://kogatana-x.github.io/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/styles/default.min.css">
    <link rel="stylesheet" href="https://kogatana-x.github.io/kogatana-x.css">

    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/languages/javascript.min.js"></script>
</head>
<body>

    <div class="navbar">
        <a href="https://kogatana-x.github.io/">
            <img src="https://kogatana-x.github.io/images/22989723.png" alt="Profile"> 
        </a>
        <h2>kogatana-x</h2>
        <p>Offensive//Defensive Security</p>
        <div class="social">
            <a href="https://github.com/kogatana-x" target="_blank" rel="noreferrer noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ee4c4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
                    <title>Github</title>
                    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                </svg>
            </a>
            <a href="https://www.linkedin.com/in/anna-andler" target="_blank" rel="noreferrer noopener">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ee4c4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
                    <title>LinkedIn</title>
                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
                </svg>
            </a>
        </div>
    </div>

    <div class="content">
        <a href="https://kogatana-x.github.io/" style="text-decoration: none;">
            <div class="banner">
                <pre>

    ██╗  ██╗ ██████╗  ██████╗  █████╗ ████████╗ █████╗ ███╗   ██╗ █████╗      ██╗  ██╗
    ██║ ██╔╝██╔═══██╗██╔════╝ ██╔══██╗╚══██╔══╝██╔══██╗████╗  ██║██╔══██╗     ╚██╗██╔╝
    █████╔╝ ██║   ██║██║  ███╗███████║   ██║   ███████║██╔██╗ ██║███████║█████╗╚███╔╝ 
    ██╔═██╗ ██║   ██║██║   ██║██╔══██║   ██║   ██╔══██║██║╚██╗██║██╔══██║╚════╝██╔██╗ 
    ██║  ██╗╚██████╔╝╚██████╔╝██║  ██║   ██║   ██║  ██║██║ ╚████║██║  ██║     ██╔╝ ██╗
    ╚═╝  ╚═╝ ╚═════╝  ╚═════╝ ╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝     ╚═╝  ╚═╝                                                                                 

    ──────────────────────────────────────────────────────────────────────────────────
                </pre>
            </div>   
        </a>      
        <div class="blog-post">   
            <h1>Malware Reversing Exercise Report</h1> 
            <time datetime="2024-05-29T12:21:45">May 29th, 2024</time> 
            <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
            <h2>Introduction</h2>
            <p>This is a sample report of a reverse engineering exercise I made for a cybersecurity competition a few years back. The exercise was to reverse engineer a piece of malware and document findings and process.</p>
            <p>The malware was a simple VBA macro embedded in an excel sheet that would download and execute a payload from a remote server.</p>

            <h2>Executive Summary</h2>
            <h3>Purpose</h3>
            <p>This report seeks to identify any malicious code contained in the file invoice-02-01-2022.xls, its severity and consequent impact to the company, as well as the behavior and indicators of compromise left by the software. The scope of this report includes the file, invoice-02-01-2022.xls, which coincided with a phishing email alert last Friday.  </p>
            <h3>APT Copper Crow</h3>
            <p>The current profile of the Advanced Persistent Threat (APT), Copper Crow, is mostly consistent with the malware contained in invoice-02-01-2022.xls. This file was determined to contain custom malicious code that deploys malware. No traces of Cobalt Strike, nor evidence of Meterpreter usage was identified in the analysis of invoice-02-01-2022.xls. While indeterminate, it is possible that the payload was created using Metasploit.  The malware’s domain, shinyobjects.birds, and file path to the hosted site the malware attempts to download, metal.exe,  also fit the general profile of Copper Crow. Further, Copper Crow has been observed to be active surrounding the timeline of the incident, so it is a likely that the threat agent responsible for this malware is in fact Copper Crow. </p>
            <h3>Risk</h3>
            <p>It has been observed that this particular malware sample has a low observed impact on the company. Upon opening the Excel workbook, the malware loads malicious shellcode into memory and attempts to download an executable of unknown intent from an inactive web server with an unregistered domain, shinyobjects.birds. The full path to executable the payload attempts to download is: hxxp://shinyobjects[.]birds/metal[.]exe.  This malware sample is static and does not change its signatures nor obfuscation mechanisms, does not presently self-replicate across the network, and stays contained within the file system. Presently, the malware sample does not pose a risk to compromising company assets; however, detection and prevention measures should be instated. If this site were to become active in the future, a subsequent reinvestigation should be conducted on the malicious payload. Please see the Appendix for file signatures and indicators of compromise (IoCs). </p>
            <h3>Recommendations</h3>
            <p>It is advised that signatures and identified indicators of compromise (IoCs) be updated to endpoint detection databases and network endpoints, to alert and restrict callouts. ASC also recommends that company employees and contractors undergo phishing awareness training to ensure that similar malicious software cannot replicate within the internal network. The executable which malicious payload downloads was not able to be recovered. If feasible, the company should pursue further investigations in recovering this executable to accurately assess business impact. </p>
            <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
            <h2>Analysis</h2>
            <h3>Tools</h3>
            <p>A REMnux Linux VM equipped with malware reversing tools was utilized to analyze the provided file. REMnux  is a versatile operating system equipped with pre-installed reverse-engineering and malicious software analysis tools. This OS was selected to ensure that the results garnered from the investigation are accurate and were completed efficiently. </p>
            <p>Within the REMnux toolkit, Oletools was used to determine the severity of the malicious software in the given file, identify a timeline, and to extract the malicious code. Oletools is a collection of “python tools that analyze Microsoft OLE2 files” . CyberChef  was utilized to decode the identified obfuscated payload. ScDbg was used to analyze the extracted shellcode payload. ScDbg is an open-source shellcode analysis application that emulates the execution of shellcode in a 32bit Windows system . </p>
            <p>After determining the extent of damage the malicious software is capable of, the sample was executed and monitored in a sandboxed Windows 7 Virtual Machine (VM). This VM is equipped with monitoring and detection tools that assist with obtaining IoCs on an endpoint workstation at a network and OS level. The VM is airgapped from the rest of the network to ensure the sample is contained within the host and contains Wireshark, Sysinternals Suite, equipped with Sysmon and SwiftOnSecurity’s Sysmon template for obtaining corresponding Windows Event IDs.</p>

            <h3>Timeline</h3>
            <p>The file, invoice-02-01-2022.xls has been determined to be owned by the user Dmitri and was last saved at 00:00:22AM February 1st 2022 UTC. This information was determined using Oletools’s olemeta binary with the command olemeta invoice-02-01-2022.zip -z infected. </p>
            <img style="width: 45%;" src="https://kogatana-x.github.io/images/Malware-Exercise-Report/olemeta.png" alt="The author and last save date of the file using Olemeta">

            <h3>Malicious Software Analysis</h3>
            <h4>Suspicious Functions Used</h4>
            <p>To determine the intent of the file, MacroRaptor, a program in Oletools that detects common malware heuristics, was used to identify suspicious functions within the file that reflect malintent. MacroRaptor determined that the file contained “Auto_Open”, which is used to execute code when a file is opened, “VirtualAlloc” and “CreateThread”, which are used to execute code directly into memory. Accordingly, it is highly likely that this file contains malware and should be analyzed further. The command used to analyze the file is mraptor invoice-02-01-2022.zip -z infected.</p>
            <img style="width: 55%;" src="https://kogatana-x.github.io/images/Malware-Exercise-Report/mraptor.png" alt="MacroRaptor results indicating that this file likely contains malware. ">

            <h4>Extracting Visual Basic Code</h4>
            <p>Using Oletools’ olevba, the malicious code contained in Module1.bas was extracted from the file for further analysis. The command used to extract this code was olevba invoice-02-01-2022.zip -z infected. </p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/olevba.png" alt="The variables and environment defined in extracted Visual Basic code">
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/olevba2.png" alt="The array obfuscated with decimal defined in the extracted Visual Basic code">
            <img style="width: 50%;" src="https://kogatana-x.github.io/images/Malware-Exercise-Report/olevba3.png" alt="The obfuscated function contained in the extracted Visual Basic code">
            <p>The code shown in Figure 5 has also been obfuscated. To make analyzing the malicious code easier, the variables used were then rewritten to a more descriptive format, as illustrated below.</p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/olevba4.png" alt="The translated code from Figure 5">
            <p>The code shown in Figures 3 and 4 define the variables used in the remainder of the malicious function. It seems that the array defined in Figure 4 has been encoded with decimal. The code shown in Figure 5 runs the data defined in the decimal array from Figure 4 directly from memory. It allocates enough space in memory for the obfuscated array shown in Figure 4, and then creates and starts a thread to execute the data contained in the obfuscated array. </p>

            <h4>Decoding the Obfuscated Payload</h4>
            <p>As it was determined the obfuscated decimal array shown in Figure 4 is some sort of binary data that can be executed, CyberChef was used to decode this array for further analysis. Using CyberChef, a simple recipe of “From Decimal” using spaces or commas as a delimiter decoded the byte array into its true form as shellcode.</p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/cyberchef.png" alt="The decoded shellcode from the obfuscated decimal array">
        
            <h4>Shellcode Analysis</h4>
            <p>Looking at the shell code, the strings “hnet” and “hwini” were used. This means that net.dll and wininet.dll are pushed onto the stack for execution in this sample. shinyobjects.birds, /metal.exe, and chrome.exe are readable strings within this shellcode, but their purpose is indeterminate from the shellcode alone. </p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/shellcode.png" alt="The shellcode extracted from the obfuscated decimal array">
        
            <p>To get a better understanding of what the shellcode does, ScDbg was used in conjunction with wine to let a native Windows program run on a Linux system. The command wine scdbg.exe -s 1000000 -f shellcode.malicious was executed, where the maximum number of steps to  execute the program was set to 10000000, to ensure that the code fully executes, and where shellcode.malicious is the extracted shellcode obtained from CyberChef. </p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/scdbg.png" alt="The shellcode being executed in ScDbg">
            <p>ScDbg’s output indicated that this malware creates a process, allocates memory, writes this allocated memory with a remote thread that then opens a connection to the remote server shinyobjects.birds on port 80 and requests the file metal.exe. From there, it then downloads and renames the file to chrome.exe. After it finishes downloading, it executes the downloaded file. This malware sample is 32bit because it uses rundll32 to execute.  </p>

            <h4>Sandbox</h4>
            <p>To examine the malware’s behavior on a Windows system, the sample was executed within a sandboxed Windows 7 computer using Microsoft Excel 2013. As observed, the malicious code executed upon opening the file, and spawned the following processes under rundll32: netapi32.dll and netutils.dll, which are used to open an internet connection. and wkscli.dll which is used to run commands on the OS. The below image was obtained under the Resource Monitor tab in the Windows Task Manager.</p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/sandbox.png" alt="The processes spawned by the malware in the sandboxed Windows 7 computer">
            <p>Looking at the process hierarchy in Sysinternal’s Process Monitor, rundll32.exe is spawned as a child process of the Excel file.</p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/processmonitor.png" alt="The process hierarchy in Sysinternal's Process Monitor">
            <p>Upon further investigation with Process Monitor, like as observed from the output of ScDbg, the malware creates a rundll32.exe process and spawns a new thread. </p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/processmonitor2.png" alt="The rundll32.exe process and spawned thread in Process Monitor">
            <p>The server, shinyobjects.birds, was not able to be resolved into an ip address, so it seems like the web server is unmanaged and/or inactive. Likewise, the executable, metal.exe, was not able to be recovered from the malware’s webserver, so no further analysis was able to be performed on this malware. </p>
            <p>Upon inspecting the corresponding event ids left by the malware execution, a similar output from Process Monitor was obtained showing the creation of a new process and a thread. The corresponding event ids obtained with Sysmon detection were 1, 8, and 13. </p>
            <img src="https://kogatana-x.github.io/images/Malware-Exercise-Report/sysmon.png" alt="The event ids left by the malware execution">
            <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
            <h2>Appendix</h2>
            <h3>Indicators of Compromise</h3>
            <table>
                <thead>
                    <tr>
                        <th>Indicator</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>invoice-02-01-2022.xls</td><td>File</td></tr>
                    <tr><td>shinyobjects.birds</td><td>Domain</td></tr>
                    <tr><td>metal.exe</td><td>File</td></tr>
                    <tr><td>chrome.exe</td><td>File</td></tr>
                    <tr><td>hxxp://shinyobjects[.]birds/metal[.]exe</td><td>URL</td></tr>
                </tbody>
            </table> 
            <h3>File Signatures</h3>
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>MIME Type</th>
                        <th>Size</th>
                        <th>SHA-256</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>invoice-02-01-2022.zip</td><td>application/zip</td><td>28240</td><td>d91a7c741f9ab4ef681cb4924bb04453494c5a39762501258dabf202b8ec0f0a</td></tr>
                    <tr><td>invoice-02-01-2022.xls</td><td>application/vnd.ms-excel</td><td>52736</td><td>d91a7c741f9ab4ef681cb4924bb04453494c5a39762501258dabf202b8ec0f0a</td></tr>
                    <tr><td>Module1.bas</td><td>text/plain</td><td>4804</td><td>a3d418f09132ccd1a429addfd57f02089e66b10c3787bcb55cf7b20164ba47c</td></tr>
                    <tr><td>shellcode.malicious</td><td>text/x-asm</td><td>722</td><td>34a86e8b9b3ff47f01df2d1f2ed6279abf690a0aed7f557f1757d63635bfdd8b</td></tr>
                </tbody>
            </table>

            <pre>
──────────────────────────────────────────────────────────────────────────────────

            </pre>
            <h2>Conclusion</h2>
            <p>The malware contained in invoice-02-01-2022.xls was determined to be a simple VBA macro that downloads and executes a payload from a remote server. The malware was analyzed using Oletools, CyberChef, and ScDbg to determine the extent of damage the malware is capable of. The malware was executed in a sandboxed Windows 7 VM to observe its behavior on a Windows system. The malware was determined to be static and does not pose a risk to the company’s assets at this time. However, detection and prevention measures should be instated to ensure that the malware does not become active in the future. </p>
            <p>It is recommended that signatures and identified indicators of compromise (IoCs) be updated to endpoint detection databases and network endpoints to alert and restrict callouts. Company employees and contractors should undergo phishing awareness training to ensure that similar malicious software cannot replicate within the internal network. If feasible, the company should pursue further investigations in recovering the executable that the malicious payload downloads to accurately assess business impact. </p>
            
        </div>
        </div>
        <div id="Recommended-Post">
            <h2 id="Recommended-Posts">Recommended Posts</h2>
            <div class="posts">

            <a href="https://kogatana-x.github.io/posts/Reversing-C2.html">
                    <h3>Reversing Sliver C2</h3>
                    <p>Learn how to reverse engineer a C2 server and understand how it works</p>
            </a>
            <a href="https://kogatana-x.github.io/posts/Attacking-and-Defending-Azure-Storage-Blobs.html">
                <h3>Attacking and Defending Azure Storage Blobs</h3>
                <p>Learn how an attacker exploits Azure Storage Blobs and how to defend them</p>
            </a>
        </div>
    </div>
</div>
       <div class="footer">
            <p>© 2021 kogatana-x</p>
        </div>
    </div>

</body>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
  document.querySelectorAll('pre code').forEach((block) => {
    hljs.highlightElement(block);
  });
});
</script>
</html>
